import subprocess
import pandas as pd
from datetime import datetime
from io import StringIO
import os

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ø­Ø²Ù…
INTERFACE_NUMBER = 4  # ØºÙŠÙ‘Ø± Ø§Ù„Ø±Ù‚Ù… Ø­Ø³Ø¨ ÙˆØ§Ø¬Ù‡ØªÙƒ (Ø´ÙˆÙÙ‡Ø§ Ø¨Ù€ tshark -D)
PACKET_COUNT = 50     # Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø²Ù… Ø§Ù„Ù„ÙŠ ØªØ¨ØºÙ‰ ØªÙ„ØªÙ‚Ø·Ù‡Ø§

# Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ù† TShark
FIELDS = [
    "-e", "frame.time_relative",
    "-e", "ip.src",
    "-e", "ip.dst",
    "-e", "_ws.col.Protocol",
    "-e", "frame.len"
]

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ù…Ø± tshark
command = [
    "tshark",
    "-i", str(INTERFACE_NUMBER),
    "-c", str(PACKET_COUNT),
    "-T", "fields",
    "-E", "separator=,", 
    "-E", "quote=d",
    "-E", "header=y"
] + FIELDS

def capture_packets():
    print(f"ğŸš€ Starting capture on interface {INTERFACE_NUMBER} for {PACKET_COUNT} packets...\n")
    try:
        result = subprocess.run(command, capture_output=True, text=True, check=True)

        # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†Ø§ØªØ¬ Ø¥Ù„Ù‰ DataFrame
        df = pd.read_csv(StringIO(result.stdout))

        # ØªØ¬Ù‡ÙŠØ² Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"packets_{timestamp}.csv"

        # Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ CSV
        df.to_csv(filename, index=False)
        print(f"âœ… Packets saved to: {filename}")
        print(df.head())  # Ø¹Ø±Ø¶ Ø£ÙˆÙ„ 5 ØµÙÙˆÙ ÙƒØªØ¬Ø±Ø¨Ø©

    except subprocess.CalledProcessError as e:
        print("âŒ Error running tshark:\n", e.stderr)

if __name__ == "__main__":
    capture_packets()
